<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>AI æ¼«å‰§ Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #050816;
        --card-bg: #0f172a;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.15);
        --text: #e5e7eb;
        --text-soft: #9ca3af;
        --border: #1f2937;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: 32px 16px;
      }
      .app {
        width: 100%;
        max-width: 960px;
      }
      .card {
        background: radial-gradient(circle at top, #020617 0, #020617 55%);
        border-radius: 24px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9);
        padding: 24px 24px 28px;
        backdrop-filter: blur(18px);
      }
      .hero {
        text-align: center;
        margin-bottom: 24px;
      }
      .hero-title-cn {
        font-size: 36px;
        font-weight: 800;
        letter-spacing: 0.18em;
        text-indent: 0.18em;
        background: linear-gradient(120deg, #a5b4fc, #38bdf8, #22d3ee);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 6px;
      }
      .hero-title-en {
        font-size: 11px;
        letter-spacing: 0.36em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.85);
        margin-bottom: 12px;
      }
      .hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(56, 189, 248, 0.6);
        background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), #020617);
        font-size: 11px;
        color: #bae6fd;
      }
      .hero-badge-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
      }
      .title {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 6px;
      }
      .title-pill {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(56, 189, 248, 0.45);
        background: radial-gradient(circle at top, #0f172a, #020617);
        color: var(--accent);
      }
      .subtitle {
        font-size: 14px;
        color: var(--text-soft);
        margin-bottom: 18px;
      }
      .scene-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 14px;
        margin-bottom: 22px;
      }
      .scene-card {
        border-radius: 18px;
        border: 1px solid rgba(30, 64, 175, 0.8);
        background: radial-gradient(circle at top left, #020617, #020617);
        padding: 14px 14px 12px;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.16s ease,
          border-color 0.16s ease, background 0.16s ease;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .scene-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 16px 45px rgba(15, 23, 42, 0.9);
        border-color: rgba(56, 189, 248, 0.95);
        background: radial-gradient(circle at top left, #0b1120, #020617);
      }
      .scene-emoji {
        font-size: 22px;
        margin-bottom: 4px;
      }
      .scene-title {
        font-size: 15px;
        font-weight: 600;
        color: #38bdf8;
      }
      .scene-desc {
        font-size: 12px;
        color: var(--text-soft);
      }
      .form-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
      }
      .field-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      label {
        font-size: 12px;
        color: var(--text-soft);
        margin-bottom: 4px;
        display: inline-block;
      }
      input,
      select,
      button,
      textarea {
        font: inherit;
      }
      .input,
      .select,
      .textarea {
        width: 100%;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top left, #020617, #020617);
        color: var(--text);
        padding: 8px 14px;
        font-size: 13px;
        outline: none;
        transition: border-color 0.18s ease, box-shadow 0.18s ease,
          background 0.18s ease, transform 0.08s ease;
      }
      .textarea {
        border-radius: 14px;
        min-height: 64px;
        resize: vertical;
        line-height: 1.5;
      }
      .input:focus,
      .select:focus,
      .textarea:focus {
        border-color: rgba(56, 189, 248, 0.8);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      }
      .select {
        appearance: none;
        padding-right: 28px;
        position: relative;
        background-image: linear-gradient(45deg, transparent 50%, #64748b 50%),
          linear-gradient(135deg, #64748b 50%, transparent 50%);
        background-position: calc(100% - 14px) 12px, calc(100% - 9px) 12px;
        background-size: 5px 5px, 5px 5px;
        background-repeat: no-repeat;
      }
      .button-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 4px;
      }
      .button {
        border-radius: 999px;
        border: none;
        padding: 8px 18px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
        color: #0b1220;
        box-shadow: 0 14px 35px rgba(56, 189, 248, 0.35);
        transition: transform 0.08s ease, box-shadow 0.08s ease,
          filter 0.12s ease;
      }
      .button span.icon {
        font-size: 14px;
      }
      .button:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
        transform: none;
      }
      .button:not(:disabled):hover {
        transform: translateY(-1px);
        filter: brightness(1.02);
      }
      .button:not(:disabled):active {
        transform: translateY(0);
        box-shadow: 0 10px 24px rgba(56, 189, 248, 0.28);
      }
      .hint {
        font-size: 11px;
        color: var(--text-soft);
      }
      .status {
        min-height: 20px;
        font-size: 12px;
        margin-top: 4px;
      }
      .status--loading {
        color: var(--accent);
      }
      .status--error {
        color: #fca5a5;
      }
      .status--success {
        color: #4ade80;
      }
      .episode {
        margin-top: 22px;
        border-top: 1px dashed rgba(148, 163, 184, 0.4);
        padding-top: 18px;
      }
      .episode-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 16px;
      }
      .episode-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .episode-desc {
        font-size: 12px;
        color: var(--text-soft);
      }
      .pill {
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        color: var(--text-soft);
      }
      .frames-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 14px;
      }
      .frame-card {
        border-radius: 16px;
        border: 1px solid rgba(30, 64, 175, 0.65);
        background: radial-gradient(circle at top left, #020617, #020617);
        padding: 10px 10px 11px;
        position: relative;
        overflow: hidden;
      }
      .frame-index {
        position: absolute;
        top: 8px;
        left: 9px;
        font-size: 11px;
        color: rgba(148, 163, 184, 0.85);
      }
      .frame-image {
        border-radius: 12px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        background: linear-gradient(135deg, #020617, #020617);
        height: 108px;
        margin-top: 14px;
        margin-bottom: 8px;
        padding: 8px;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
      }
      .frame-image-text {
        font-size: 11px;
        color: var(--text-soft);
        line-height: 1.5;
      }
      .frame-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 4px;
      }
      .frame-speaker {
        font-size: 12px;
        font-weight: 500;
      }
      .frame-mood {
        font-size: 11px;
        color: #fde68a;
      }
      .frame-dialogue {
        font-size: 12px;
        margin-bottom: 2px;
      }
      .frame-narration {
        font-size: 11px;
        color: var(--text-soft);
      }
      .frame-audio-row {
        margin-top: 6px;
        display: flex;
        justify-content: flex-end;
      }
      .frame-audio-btn {
        border-radius: 999px;
        border: none;
        padding: 2px 9px 3px;
        font-size: 11px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(56, 189, 248, 0.1);
        color: var(--accent);
        transition: background 0.12s ease, transform 0.08s ease;
      }
      .frame-audio-btn span.icon {
        font-size: 12px;
      }
      .frame-audio-btn:hover {
        background: rgba(56, 189, 248, 0.2);
        transform: translateY(-0.5px);
      }

      .dialog-card {
        margin-top: 18px;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 12px 12px 14px;
        background: radial-gradient(circle at top left, #020617, #020617);
      }
      .dialog-title {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 6px;
      }
      .dialog-input-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 8px;
      }
      .dialog-textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top left, #020617, #020617);
        color: var(--text);
        padding: 8px 10px;
        font-size: 13px;
        outline: none;
        resize: vertical;
        min-height: 48px;
      }
      .dialog-textarea:focus {
        border-color: rgba(56, 189, 248, 0.8);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      }
      .dialog-button-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .dialog-log {
        margin-top: 8px;
        max-height: 160px;
        overflow-y: auto;
        font-size: 12px;
        border-radius: 10px;
        border: 1px solid rgba(30, 64, 175, 0.7);
        padding: 6px 8px;
        background: rgba(15, 23, 42, 0.7);
      }
      .dialog-line {
        margin-bottom: 4px;
      }
      .dialog-line span.role {
        font-weight: 500;
        margin-right: 4px;
      }

      @media (max-width: 640px) {
        body {
          padding: 16px 10px;
        }
        .card {
          padding: 16px 14px 20px;
          border-radius: 18px;
        }
        .title {
          font-size: 22px;
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <div class="hero">
          <div class="hero-title-cn">å£°ä¸´å…¶å¢ƒ</div>
          <div class="hero-title-en">AI INTERACTIVE AUDIO COMIC THEATER</div>
          <div class="hero-badge">
            <span class="hero-badge-dot"></span>
            çœŸå®æ—¶è¯­éŸ³ç‰ˆ Â· å¸¦æœ‰ TTS æœ—è¯»
          </div>
        </div>

        <div class="subtitle">
          ç‚¹å‡»ä¸‹æ–¹ä»»æ„åœºæ™¯å¡ç‰‡ï¼ŒAI å°†ä¸ºä½ ç”Ÿæˆç‹¬ç‰¹çš„äº’åŠ¨æ¼«å‰§æ•…äº‹ï¼Œè‡ªåŠ¨æœ—è¯»æ¯ä¸€æ ¼åˆ†é•œã€‚
        </div>

        <!-- åœºæ™¯é€‰æ‹©åŒº -->
        <div class="scene-grid">
          <div
            class="scene-card"
            onclick="selectScene('èµ›åšä¾¦æ¢', 'æœªæ¥éƒ½å¸‚çš„è°œæ¡ˆè°ƒæŸ¥ï¼ŒAIåŠ©æ‰‹ä¸ä½ å¹¶è‚©ç ´æ¡ˆã€‚', 'èµ›åšæœ‹å…‹', 'è½»æ‚¬ç–‘')"
          >
            <div class="scene-emoji">ğŸ•µï¸â€â™‚ï¸</div>
            <div class="scene-title">èµ›åšä¾¦æ¢</div>
            <div class="scene-desc">
              éœ“è™¹éƒ½å¸‚ã€é»‘å®¢çº¿ç´¢ä¸å¤±æ§ AIï¼Œåœ¨è¾¹ç¼˜åœ°å¸¦æŸ¥å‡ºçœŸç›¸ã€‚
            </div>
          </div>

          <div
            class="scene-card"
            onclick="selectScene('æ˜Ÿé™…é‚‚é€…', 'è·¨è¶Šæ˜Ÿç³»çš„æ“¦è‚©ä¸é‡é€¢ï¼Œæ¯ä¸€æ¬¡å†³å®šéƒ½æ”¹å˜å‘½è¿è½¨è¿¹ã€‚', 'æ˜Ÿé™…æ‹æ­Œ', 'æ²»æ„ˆ')"
          >
            <div class="scene-emoji">ğŸ’«</div>
            <div class="scene-title">æ˜Ÿé™…é‚‚é€…</div>
            <div class="scene-desc">
              åœ¨å®‡å®™è¾¹ç¼˜æ¼‚æµçš„é£èˆ¹ä¸Šï¼Œé‡æ–°å®šä¹‰â€œè·ç¦»â€å’Œâ€œäº²å¯†â€ã€‚
            </div>
          </div>

          <div
            class="scene-card"
            onclick="selectScene('æ˜Ÿé™…æ¢é™©', 'æ¢ç´¢æœªçŸ¥æ˜Ÿçƒï¼Œæ¯ä¸€æ¬¡é€‰æ‹©éƒ½åœ¨æ”¹å†™å®‡å®™è§„åˆ™ã€‚', 'æ˜Ÿé™…æ¢é™©', 'çƒ­è¡€')"
          >
            <div class="scene-emoji">ğŸš€</div>
            <div class="scene-title">æ˜Ÿé™…æ¢é™©</div>
            <div class="scene-desc">
              é™è½åœ¨æ— äººæ ‡è®°çš„æ˜Ÿçƒï¼Œè„šä¸‹çš„æ¯ä¸€å—çŸ³å¤´éƒ½å¯èƒ½è—ç€ç§˜å¯†ã€‚
            </div>
          </div>

          <div
            class="scene-card"
            onclick="selectScene('åˆå¤œä¼ è¯´', 'éƒ½å¸‚æ·±å¤œç”µå°ï¼Œæ¯ä¸ªæ•…äº‹éƒ½ä»‹äºçœŸå®ä¸ä¼ è¯´ä¹‹é—´ã€‚', 'éƒ½å¸‚æ€ªè°ˆ', 'è½»æ‚¬ç–‘')"
          >
            <div class="scene-emoji">ğŸŒ™</div>
            <div class="scene-title">åˆå¤œä¼ è¯´</div>
            <div class="scene-desc">
              ä½ å’Œç”µå°å¦ä¸€ç«¯çš„ TAï¼Œä¸€èµ·æ‹¨å¼€å±‚å±‚è¿·é›¾ï¼Œé è¿‘çœŸç›¸ã€‚
            </div>
          </div>
        </div>

        <!-- éšè—çš„åŸå§‹è¾“å…¥æ§ä»¶ï¼Œç”¨äºé©±åŠ¨åç«¯é€»è¾‘ -->
        <div class="form-row" style="display: none">
          <div>
            <label for="prompt">ä¸€å¥è¯è®¾å®š</label>
            <textarea
              id="prompt"
              class="textarea"
              placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªå€’éœ‰çš„å®ä¹ ç”Ÿç¬¬ä¸€å¤©ä¸Šç­å°±é‡åˆ°äº†çµå¼‚äº‹ä»¶"
            ></textarea>
          </div>

          <div class="field-group">
            <div style="flex: 1 1 160px">
              <label for="world_view">ä¸–ç•Œè§‚ / é£æ ¼ï¼ˆå¯é€‰ï¼‰</label>
              <select id="world_view" class="select">
                <option value="">è‡ªåŠ¨</option>
                <option value="éƒ½å¸‚èŒåœº">éƒ½å¸‚èŒåœº</option>
                <option value="æ ¡å›­å¥‡è°ˆ">æ ¡å›­å¥‡è°ˆ</option>
                <option value="èµ›åšæœ‹å…‹">èµ›åšæœ‹å…‹</option>
                <option value="æ­¦ä¾ æ±Ÿæ¹–">æ­¦ä¾ æ±Ÿæ¹–</option>
              </select>
            </div>
            <div style="flex: 1 1 140px">
              <label for="tone">åŸºè°ƒï¼ˆå¯é€‰ï¼‰</label>
              <select id="tone" class="select">
                <option value="">è‡ªåŠ¨</option>
                <option value="æç¬‘">æç¬‘</option>
                <option value="è½»æ‚¬ç–‘">è½»æ‚¬ç–‘</option>
                <option value="çƒ­è¡€">çƒ­è¡€</option>
                <option value="æ²»æ„ˆ">æ²»æ„ˆ</option>
              </select>
            </div>
          </div>
        </div>

        <div class="button-row" style="display:none">
          <button id="generate_btn" class="button">
            <span class="icon">ğŸ¬</span>
            ç”Ÿæˆä¸€é›†çŸ­æ¼«
          </button>
          <div class="hint">
            å°è´´å£«ï¼šå…ˆç”¨é»˜è®¤å‡æ•°æ®è·‘é€šï¼Œåé¢æˆ‘ä»¬å†ä¸€èµ·æ¥å…¥çœŸå®å¤§æ¨¡å‹ã€‚
          </div>
        </div>

        <div id="status" class="status"></div>

        <div id="episode_container" class="episode" style="display: none"></div>

        <div class="dialog-card">
          <div class="dialog-title">ğŸ­ å®‡å®™æ‚¬ç–‘ Â· å¥³ä¸»å¯¹è¯æ¨¡å¼ï¼ˆéŸ³é¢‘äº’åŠ¨ç‰ˆï¼‰</div>
          <div class="dialog-input-row">
            <textarea
              id="dialog_input"
              class="dialog-textarea"
              placeholder="å¯¹å¥¹è¯´ç‚¹ä»€ä¹ˆï¼Œä¾‹å¦‚ï¼šç»§ç»­æ˜¨å¤©é‚£ä¸ªå®‡å®™æ‚¬ç–‘æ•…äº‹ï¼Œä½†ä»Šå¤©æˆ‘æƒ³è®©ä½ æ›´ç‹ ä¸€ç‚¹ã€‚"
            ></textarea>
          </div>
          <div class="dialog-button-row" style="flex-wrap:wrap;gap:8px">
            <button id="dialog_send_btn" class="button" style="padding:6px 14px;font-size:12px">
              <span class="icon">âœï¸</span>
              å‘é€æ–‡å­—
            </button>
            <button 
              id="voice_record_btn" 
              class="button" 
              style="padding:6px 14px;font-size:12px;background:radial-gradient(circle at top left, #ef4444, #dc2626);box-shadow:0 14px 35px rgba(239, 68, 68, 0.35);"
              onmousedown="startVoiceRecording()"
              onmouseup="stopVoiceRecording()"
              ontouchstart="startVoiceRecording(); return false;"
              ontouchend="stopVoiceRecording(); return false;"
            >
              <span class="icon" id="voice_icon">ğŸ¤</span>
              <span id="voice_btn_text">æŒ‰ä½è¯´è¯</span>
            </button>
            <button 
              id="interrupt_btn" 
              class="button" 
              style="padding:6px 14px;font-size:12px;background:radial-gradient(circle at top left, #f59e0b, #d97706);box-shadow:0 14px 35px rgba(245, 158, 11, 0.35);display:none;"
              onclick="interruptAndSpeak()"
            >
              <span class="icon">â¸ï¸</span>
              æ‰“æ–­å¹¶è¯´è¯
            </button>
          </div>
          <div class="hint" style="margin-top:4px">
            ğŸ’¡ <strong>éŸ³é¢‘äº’åŠ¨</strong>ï¼šæŒ‰ä½ã€ŒæŒ‰ä½è¯´è¯ã€æŒ‰é’®ï¼Œè¯´å‡ºä½ çš„è¯ï¼ŒAI ä¼šç«‹å³åœæ­¢å½“å‰æ’­æ”¾å¹¶å›åº”ä½ ã€‚æ•…äº‹æ’­æ”¾æ—¶ï¼ŒæŒ‰é’®ä¼šå˜æˆã€Œæ‰“æ–­å¹¶è¯´è¯ã€ã€‚
          </div>
          <div id="dialog_log" class="dialog-log" style="display:none"></div>
        </div>
      </div>
    </div>

    <script>
      // ä½¿ç”¨ var å£°æ˜å…¨å±€å˜é‡ï¼Œé¿å… TDZ (Temporal Dead Zone) é”™è¯¯
      // var ä¼šè¢«æå‡åˆ°ä½œç”¨åŸŸé¡¶éƒ¨ï¼Œä¸ä¼šæœ‰åˆå§‹åŒ–é¡ºåºé—®é¢˜
      var currentEpisode = null;
      var currentUtterance = null;
      var dialogHistory = [];
      var autoPlayQueue = [];
      var isAutoPlaying = false;
      var recognition = null;
      var isRecording = false;
      var voiceRecordBtn = null;
      var interruptBtn = null;
      
      // å¤šåˆ†æ”¯æ•…äº‹ç³»ç»Ÿï¼šè®°å½•é€‰æ‹©å†å²å’Œæ•…äº‹è·¯å¾„
      var choiceHistory = [];  // ç”¨æˆ·åšè¿‡çš„æ‰€æœ‰é€‰æ‹©
      var branchDepth = 0;     // å½“å‰åˆ†æ”¯æ·±åº¦ï¼ˆç¬¬å‡ æ¬¡é€‰æ‹©ï¼‰
      var storyPath = [];      // å®Œæ•´çš„æ•…äº‹è·¯å¾„ï¼ˆç”¨äºç”Ÿæˆä¸åŒç»“å±€ï¼‰

      // ç„¶ååˆå§‹åŒ– DOM å…ƒç´ å’Œå¸¸é‡
      const API_BASE = "http://127.0.0.1:8000";
      const promptInput = document.getElementById("prompt");
      const worldSelect = document.getElementById("world_view");
      const toneSelect = document.getElementById("tone");
      const generateBtn = document.getElementById("generate_btn");
      const statusEl = document.getElementById("status");
      const episodeContainer = document.getElementById("episode_container");
      const dialogInput = document.getElementById("dialog_input");
      const dialogSendBtn = document.getElementById("dialog_send_btn");
      const dialogLogEl = document.getElementById("dialog_log");
      
      // åˆå§‹åŒ–æŒ‰é’®å¼•ç”¨
      voiceRecordBtn = document.getElementById("voice_record_btn");
      interruptBtn = document.getElementById("interrupt_btn");
      
      // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          if (transcript.trim()) {
            dialogInput.value = transcript;
            // è‡ªåŠ¨å‘é€
            sendDialogTurn();
          }
        };
        
        recognition.onerror = (event) => {
          console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
          setStatus(`è¯­éŸ³è¯†åˆ«å¤±è´¥: ${event.error}`, "error");
          isRecording = false;
          updateVoiceButtonState();
        };
        
        recognition.onend = () => {
          isRecording = false;
          updateVoiceButtonState();
        };
        
        // é¢„å…ˆè¯·æ±‚éº¦å…‹é£æƒé™ï¼Œé¿å…æ¯æ¬¡ç‚¹å‡»éƒ½å¼¹çª—
        // ä½¿ç”¨ getUserMedia å…ˆè·å–æƒé™ï¼Œè¿™æ ·åç»­ SpeechRecognition å°±ä¸ä¼šå†å¼¹çª—
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ audio: true })
            .then((stream) => {
              // æƒé™å·²è·å–ï¼Œç«‹å³å…³é—­æµï¼ˆæˆ‘ä»¬åªéœ€è¦æƒé™ï¼Œä¸éœ€è¦å®é™…ä½¿ç”¨è¿™ä¸ªæµï¼‰
              stream.getTracks().forEach(track => track.stop());
              console.log('éº¦å…‹é£æƒé™å·²é¢„å…ˆè·å–');
            })
            .catch((err) => {
              console.warn('é¢„å…ˆè·å–éº¦å…‹é£æƒé™å¤±è´¥ï¼ˆä¸å½±å“åç»­ä½¿ç”¨ï¼‰:', err);
              // è¿™é‡Œä¸æ˜¾ç¤ºé”™è¯¯ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½è¿˜æ²¡å‡†å¤‡å¥½æˆæƒ
              // ç­‰ç”¨æˆ·çœŸæ­£ç‚¹å‡»æŒ‰é’®æ—¶å†å¤„ç†
            });
        }
      }
      
      function updateVoiceButtonState() {
        if (!voiceRecordBtn) return;
        if (isRecording) {
          voiceRecordBtn.style.background = 'radial-gradient(circle at top left, #ef4444, #dc2626)';
          voiceRecordBtn.style.boxShadow = '0 14px 35px rgba(239, 68, 68, 0.5)';
          document.getElementById('voice_icon').textContent = 'ğŸ”´';
          document.getElementById('voice_btn_text').textContent = 'æ­£åœ¨å½•éŸ³...';
        } else {
          voiceRecordBtn.style.background = 'radial-gradient(circle at top left, #ef4444, #dc2626)';
          voiceRecordBtn.style.boxShadow = '0 14px 35px rgba(239, 68, 68, 0.35)';
          document.getElementById('voice_icon').textContent = 'ğŸ¤';
          document.getElementById('voice_btn_text').textContent = 'æŒ‰ä½è¯´è¯';
        }
      }
      
      async function startVoiceRecording() {
        if (!recognition) {
          setStatus("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Chrome/Edge æµè§ˆå™¨ã€‚", "error");
          return;
        }
        
        if (isRecording) return;
        
        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
        if (isAutoPlaying || window.speechSynthesis.speaking) {
          stopSpeaking();
        }
        
        // ç¡®ä¿éº¦å…‹é£æƒé™å·²è·å–ï¼ˆé¿å…æ¯æ¬¡å¼¹çª—ï¼‰
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          try {
            // å…ˆè·å–æƒé™ï¼ˆå¦‚æœè¿˜æ²¡è·å–çš„è¯ï¼‰
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            // ç«‹å³å…³é—­æµï¼ˆæˆ‘ä»¬åªéœ€è¦æƒé™ï¼Œä¸éœ€è¦å®é™…ä½¿ç”¨è¿™ä¸ªæµï¼‰
            stream.getTracks().forEach(track => track.stop());
          } catch (err) {
            // å¦‚æœæƒé™è¢«æ‹’ç»ï¼Œæç¤ºç”¨æˆ·
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
              setStatus("éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½ä½¿ç”¨è¯­éŸ³åŠŸèƒ½ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®ã€‚", "error");
              return;
            }
            console.warn('è·å–éº¦å…‹é£æƒé™æ—¶å‡ºé”™:', err);
            // ç»§ç»­å°è¯•å¯åŠ¨è¯†åˆ«ï¼ˆå¯èƒ½æƒé™å·²ç»è·å–äº†ï¼‰
          }
        }
        
        try {
          recognition.start();
          isRecording = true;
          updateVoiceButtonState();
          setStatus("ğŸ¤ æ­£åœ¨å¬ä½ è¯´è¯â€¦", "loading");
        } catch (e) {
          console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', e);
          isRecording = false;
          updateVoiceButtonState();
          if (e.message && e.message.includes('not-allowed')) {
            setStatus("éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ã€‚", "error");
          }
        }
      }
      
      function stopVoiceRecording() {
        if (recognition && isRecording) {
          recognition.stop();
          isRecording = false;
          updateVoiceButtonState();
        }
      }
      
      function interruptAndSpeak() {
        // åœæ­¢å½“å‰æ’­æ”¾
        stopSpeaking();
        // å¼€å§‹å½•éŸ³
        startVoiceRecording();
      }

      function selectScene(title, prompt, world_view, tone) {
        // è®¾ç½®éšè—è¡¨å•çš„å€¼ï¼Œä¾¿äºå¤ç”¨åç«¯æ¥å£
        promptInput.value = prompt;
        worldSelect.value = world_view || "";
        toneSelect.value = tone || "";

        // æ›´æ–°çŠ¶æ€æ æç¤º
        setStatus(`å·²é€‰æ‹©åœºæ™¯ã€Œ${title}ã€ï¼Œæ­£åœ¨ç”Ÿæˆæ•…äº‹â€¦`, "loading");

        // è§¦å‘ç”Ÿæˆé€»è¾‘
        generateEpisode();
      }

      function setStatus(text, type) {
        statusEl.textContent = text || "";
        statusEl.className = "status";
        if (type) {
          statusEl.classList.add(`status--${type}`);
        }
      }

      async function generateEpisode() {
        const prompt = promptInput.value.trim();
        const world_view = worldSelect.value || null;
        const tone = toneSelect.value || null;

        if (!prompt) {
          setStatus("è¯·å…ˆè¾“å…¥ä¸€å¥è¯è®¾å®šã€‚", "error");
          promptInput.focus();
          return;
        }

        generateBtn.disabled = true;
        setStatus("æ­£åœ¨ç”ŸæˆçŸ­æ¼«åˆ†é•œï¼Œè¯·ç¨å€™â€¦", "loading");

        try {
          const resp = await fetch(`${API_BASE}/generate_episode`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ prompt, world_view, tone }),
          });

          if (!resp.ok) {
            const text = await resp.text();
            console.error("HTTP é”™è¯¯:", resp.status, text);
            throw new Error(`HTTP ${resp.status}: ${text}`);
          }

          const data = await resp.json();
          console.log("æ”¶åˆ°å“åº”æ•°æ®:", data);
          
          // éªŒè¯å“åº”æ ¼å¼
          if (!data || !Array.isArray(data.frames)) {
            console.error("å“åº”æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘ frames å­—æ®µ:", data);
            throw new Error("åç«¯è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ frames å­—æ®µ");
          }
          
          currentEpisode = data;
          
          // é‡ç½®é€‰æ‹©å†å²ï¼ˆæ–°æ•…äº‹å¼€å§‹ï¼‰
          choiceHistory = [];
          branchDepth = 0;
          storyPath = [];
          
          renderEpisode(data);
          setStatus("ç”Ÿæˆå®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ’­æ”¾â€¦", "success");
          
          // è‡ªåŠ¨æ’­æ”¾æ‰€æœ‰åˆ†é•œ
          setTimeout(() => {
            autoPlayAllFrames(0);
          }, 500);
        } catch (err) {
          console.error("ç”Ÿæˆå¤±è´¥:", err);
          console.error("é”™è¯¯è¯¦æƒ…:", err.message, err.stack);
          setStatus(`ç”Ÿæˆå¤±è´¥: ${err.message || "è¯·æ£€æŸ¥åç«¯æ˜¯å¦å·²å¯åŠ¨ï¼ˆç«¯å£ 8000ï¼‰æˆ–ç¨åé‡è¯•"}`, "error");
        } finally {
          generateBtn.disabled = false;
        }
      }

      function renderEpisode(ep) {
        if (!ep || !Array.isArray(ep.frames)) {
          episodeContainer.style.display = "none";
          episodeContainer.innerHTML = "";
          return;
        }

        const headerHtml = `
          <div class="episode-header">
            <div>
              <div class="episode-title">${escapeHtml(ep.title || "AI æ¼«å‰§")}</div>
              <div class="episode-desc">${escapeHtml(
                ep.description || ""
              )}</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="pill">å…± ${ep.frames.length} æ ¼</div>
              ${isAutoPlaying ? `
                <button class="button" style="padding:4px 10px;font-size:11px" onclick="stopSpeaking()">
                  <span class="icon">â¹ï¸</span>åœæ­¢æ’­æ”¾
                </button>
              ` : `
                <button class="button" style="padding:4px 10px;font-size:11px" onclick="autoPlayAllFrames(0)">
                  <span class="icon">â–¶ï¸</span>è‡ªåŠ¨æ’­æ”¾
                </button>
              `}
            </div>
          </div>
        `;

        const framesHtml = ep.frames
          .map((f, idx) => {
            return `
              <div class="frame-card">
                <div class="frame-index">#${f.index}</div>
                <div class="frame-image">
                  <div class="frame-image-text">
                    ${escapeHtml(f.image_prompt || "")}
                  </div>
                </div>
                <div class="frame-meta">
                  <div class="frame-speaker">${escapeHtml(
                    f.speaker || "è§’è‰²"
                  )}</div>
                  ${
                    f.mood
                      ? `<div class="frame-mood">${escapeHtml(f.mood)}</div>`
                      : ""
                  }
                </div>
                <div class="frame-dialogue">ã€Œ${escapeHtml(
                  f.dialogue || ""
                )}ã€</div>
                ${
                  f.narration
                    ? `<div class="frame-narration">${escapeHtml(
                        f.narration
                      )}</div>`
                    : ""
                }
                <div class="frame-audio-row">
                  <button class="frame-audio-btn" onclick="onPlayFrameTTS(${idx})">
                    <span class="icon">ğŸ”Š</span>
                    å¬è¿™ä¸€æ ¼
                  </button>
                </div>
              </div>
            `;
          })
          .join("");

        let choicesHtml = "";
        if (Array.isArray(ep.choices) && ep.choices.length > 0) {
          const buttons = ep.choices
            .map(
              (c, idx) =>
                `<button class="button" style="padding:6px 14px;font-size:12px" onclick="onChoiceClick(${idx})">
                  <span class="icon">âœ¨</span>${escapeHtml(c)}
                 </button>`
            )
            .join("&nbsp;");

          // å¦‚æœåˆ†æ”¯æ·±åº¦>=3ï¼Œæ·»åŠ "ç”Ÿæˆå¦ä¸€ä¸ªç»“å±€"æŒ‰é’®
          let alternativeEndingBtn = "";
          if (branchDepth >= 3) {
            alternativeEndingBtn = `
              <div style="margin-top:12px;padding-top:12px;border-top:1px dashed rgba(148,163,184,0.3)">
                <div class="episode-desc" style="margin-bottom:6px">
                  ğŸ’¡ æƒ³çœ‹çœ‹å¦‚æœèµ°å¦ä¸€æ¡è·¯ä¼šæ€æ ·ï¼Ÿç”Ÿæˆä¸€ä¸ªå®Œå…¨ä¸åŒçš„ç»“å±€ã€‚
                </div>
                <div class="button-row" style="flex-wrap:wrap;gap:8px">
                  <button class="button" style="padding:6px 14px;font-size:12px;background:radial-gradient(circle at top left, #f59e0b, #d97706);box-shadow:0 14px 35px rgba(245, 158, 11, 0.35);" onclick="generateAlternativeEnding('æ¶äººæœ‰æ¶æŠ¥')">
                    <span class="icon">âš–ï¸</span>æ¶äººæœ‰æ¶æŠ¥
                  </button>
                  <button class="button" style="padding:6px 14px;font-size:12px;background:radial-gradient(circle at top left, #ef4444, #dc2626);box-shadow:0 14px 35px rgba(239, 68, 68, 0.35);" onclick="generateAlternativeEnding('æ¶äººæ´»åˆ°æœ€å')">
                    <span class="icon">ğŸ˜ˆ</span>æ¶äººæ´»åˆ°æœ€å
                  </button>
                  <button class="button" style="padding:6px 14px;font-size:12px;background:radial-gradient(circle at top left, #8b5cf6, #7c3aed);box-shadow:0 14px 35px rgba(139, 92, 246, 0.35);" onclick="generateAlternativeEnding('å¼€æ”¾å¼ç»“å±€')">
                    <span class="icon">ğŸŒŒ</span>å¼€æ”¾å¼ç»“å±€
                  </button>
                </div>
              </div>
            `;
          }
          
          choicesHtml = `
            <div style="margin-top:16px">
              <div class="episode-desc" style="margin-bottom:6px">
                ä½ ä¼šæ€ä¹ˆé€‰ï¼Ÿé€‰æ‹©ä¸€ä¸ªåˆ†æ”¯ï¼Œè®© AI ä¸ºä½ ç»­å†™å®Œæ•´çš„æ•…äº‹æ®µè½ã€‚
                ${branchDepth > 0 ? `<br><small style="color:var(--text-soft);">å½“å‰è·¯å¾„ï¼š${storyPath.join(' â†’ ')}</small>` : ''}
              </div>
              <div class="button-row" style="flex-wrap:wrap;gap:8px">
                ${buttons}
              </div>
              ${alternativeEndingBtn}
            </div>
          `;
        }

        episodeContainer.innerHTML =
          headerHtml +
          `<div class="frames-grid">${framesHtml}</div>` +
          choicesHtml;
        episodeContainer.style.display = "block";
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      generateBtn.addEventListener("click", generateEpisode);

      function stopSpeaking() {
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
        }
        currentUtterance = null;
        autoPlayQueue = [];
        isAutoPlaying = false;
        // éšè—"æ‰“æ–­å¹¶è¯´è¯"æŒ‰é’®
        if (interruptBtn) {
          interruptBtn.style.display = 'none';
        }
        // å¦‚æœå½“å‰æœ‰ episodeï¼Œé‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€
        try {
          if (typeof currentEpisode !== 'undefined' && currentEpisode) {
            renderEpisode(currentEpisode);
          }
        } catch (e) {
          console.warn('stopSpeaking: currentEpisode æœªåˆå§‹åŒ–', e);
        }
        setStatus("å·²åœæ­¢æ’­æ”¾ã€‚", "");
      }

      // è‡ªåŠ¨æŒ‰é¡ºåºæ’­æ”¾æ‰€æœ‰åˆ†é•œ
      function autoPlayAllFrames(startIndex = 0) {
        try {
          if (typeof currentEpisode === 'undefined' || !currentEpisode || !Array.isArray(currentEpisode.frames)) {
            return;
          }
        } catch (e) {
          console.warn('autoPlayAllFrames: currentEpisode æœªåˆå§‹åŒ–', e);
          return;
        }

        const frames = currentEpisode.frames;
        if (startIndex >= frames.length) {
          isAutoPlaying = false;
          setStatus("æ•…äº‹æ’­æ”¾å®Œæˆã€‚", "success");
          // æ›´æ–°æ¸²æŸ“ä»¥æ˜¾ç¤º"è‡ªåŠ¨æ’­æ”¾"æŒ‰é’®
          if (currentEpisode) {
            renderEpisode(currentEpisode);
          }
          return;
        }

        isAutoPlaying = true;
        // æ˜¾ç¤º"æ‰“æ–­å¹¶è¯´è¯"æŒ‰é’®
        if (interruptBtn) {
          interruptBtn.style.display = 'inline-flex';
        }
        
        const frame = frames[startIndex];
        if (!frame) {
          autoPlayAllFrames(startIndex + 1);
          return;
        }

        // åªåœæ­¢å½“å‰æ’­æ”¾ï¼Œä¸é‡ç½® isAutoPlaying
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
        }
        currentUtterance = null;

        const speaker = frame.speaker || "æ—ç™½";
        const dialogue = frame.dialogue || "";
        const narration = frame.narration || "";

        const text =
          (speaker ? speaker + "ï¼š" : "") +
          dialogue +
          (narration ? "ã€‚" + narration : "");

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "zh-CN";
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        currentUtterance = utterance;

        // æ’­æ”¾å®Œæˆåè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€æ ¼
        utterance.onend = () => {
          // çŸ­æš‚åœé¡¿åæ’­æ”¾ä¸‹ä¸€æ ¼
          setTimeout(() => {
            if (isAutoPlaying) {
              autoPlayAllFrames(startIndex + 1);
            }
          }, 300);
        };

        utterance.onerror = () => {
          // å‡ºé”™ä¹Ÿç»§ç»­æ’­æ”¾ä¸‹ä¸€æ ¼
          setTimeout(() => {
            if (isAutoPlaying) {
              autoPlayAllFrames(startIndex + 1);
            }
          }, 300);
        };

        window.speechSynthesis.speak(utterance);
        setStatus(`æ­£åœ¨æ’­æ”¾ç¬¬ ${startIndex + 1}/${frames.length} æ ¼â€¦`, "loading");
      }

      function onPlayFrameTTS(index) {
        if (
          !("speechSynthesis" in window) ||
          typeof SpeechSynthesisUtterance === "undefined"
        ) {
          setStatus("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»åŠŸèƒ½ã€‚", "error");
          return;
        }

        if (!currentEpisode || !Array.isArray(currentEpisode.frames)) return;
        const frame = currentEpisode.frames[index];
        if (!frame) return;

        stopSpeaking();

        const speaker = frame.speaker || "æ—ç™½";
        const dialogue = frame.dialogue || "";
        const narration = frame.narration || "";

        const text =
          (speaker ? speaker + "ï¼š" : "") +
          dialogue +
          (narration ? "ã€‚" + narration : "");

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "zh-CN";
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        currentUtterance = utterance;
        
        // æ˜¾ç¤º"æ‰“æ–­å¹¶è¯´è¯"æŒ‰é’®
        if (interruptBtn) {
          interruptBtn.style.display = 'inline-flex';
        }
        
        utterance.onend = () => {
          if (interruptBtn) {
            interruptBtn.style.display = 'none';
          }
        };

        window.speechSynthesis.speak(utterance);
      }

      async function sendDialogTurn() {
        const utter = dialogInput.value.trim();
        if (!utter) {
          setStatus("è¯·å…ˆè¾“å…¥ä½ æƒ³å¯¹å¥¹è¯´çš„è¯ã€‚", "error");
          dialogInput.focus();
          return;
        }
        dialogSendBtn.disabled = true;
        setStatus("å¥³ä¸»æ­£åœ¨æ€è€ƒä½ çš„è¯â€¦", "loading");

        try {
          const payload = {
            utterance: utter,
            world_view: worldSelect.value || "å®‡å®™æ‚¬ç–‘",
            tone: toneSelect.value || "è½»æ‚¬ç–‘",
            history: dialogHistory,
          };

          const resp = await fetch(`${API_BASE}/voice_round`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`HTTP ${resp.status}: ${text}`);
          }

          const data = await resp.json();
          const reply = data.reply || "";
          const speaker = data.speaker || "å¥³ä¸»";

          dialogHistory.push({ role: "user", content: utter });
          dialogHistory.push({ role: "assistant", content: reply });
          renderDialogLog();

          // ç”¨æµè§ˆå™¨è¯­éŸ³è¯»å‡ºå›å¤
          if ("speechSynthesis" in window && typeof SpeechSynthesisUtterance !== "undefined") {
            stopSpeaking();
            // æ˜¾ç¤º"æ‰“æ–­å¹¶è¯´è¯"æŒ‰é’®ï¼Œå› ä¸ºå¥³ä¸»æ­£åœ¨è¯´è¯
            if (interruptBtn) {
              interruptBtn.style.display = 'inline-flex';
            }
            
            const utt = new SpeechSynthesisUtterance(reply);
            utt.lang = "zh-CN";
            utt.rate = 1.0;
            utt.pitch = 1.0;
            currentUtterance = utt;
            
            // æ’­æ”¾ç»“æŸæ—¶éšè—æŒ‰é’®
            utt.onend = () => {
              if (interruptBtn) {
                interruptBtn.style.display = 'none';
              }
            };
            
            window.speechSynthesis.speak(utt);
          }

          dialogInput.value = "";
          setStatus("å¥¹å·²ç»å›åº”ä½ äº†ã€‚", "success");
        } catch (err) {
          console.error(err);
          setStatus("å¯¹è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚", "error");
        } finally {
          dialogSendBtn.disabled = false;
        }
      }

      function renderDialogLog() {
        if (!dialogHistory.length) {
          dialogLogEl.style.display = "none";
          dialogLogEl.innerHTML = "";
          return;
        }
        const html = dialogHistory
          .map((turn) => {
            const roleLabel = turn.role === "assistant" ? "å¥³ä¸»" : "ä½ ";
            return `<div class="dialog-line"><span class="role">${escapeHtml(
              roleLabel
            )}</span>${escapeHtml(turn.content || "")}</div>`;
          })
          .join("");
        dialogLogEl.innerHTML = html;
        dialogLogEl.style.display = "block";
        dialogLogEl.scrollTop = dialogLogEl.scrollHeight;
      }

      dialogSendBtn.addEventListener("click", sendDialogTurn);

      async function onChoiceClick(index) {
        if (!currentEpisode || !Array.isArray(currentEpisode.choices)) {
          return;
        }
        const choice = currentEpisode.choices[index];
        if (!choice) return;

        // è®°å½•é€‰æ‹©å†å²
        choiceHistory.push(choice);
        branchDepth += 1;
        storyPath.push(choice);

        const prompt = promptInput.value.trim();
        const world_view = worldSelect.value || null;
        const tone = toneSelect.value || null;

        const story_outline = (currentEpisode.frames || [])
          .map((f) => `${f.speaker}: ${f.dialogue}`)
          .join("\n");

        const choiceText = branchDepth === 1 ? "ç¬¬ä¸€æ¬¡" : branchDepth === 2 ? "ç¬¬äºŒæ¬¡" : "æœ€åä¸€æ¬¡";
        setStatus(`æ­£åœ¨æ ¹æ®ä½ çš„é€‰æ‹©ç»­å†™å®Œæ•´çš„æ•…äº‹æ®µè½ï¼ˆ${choiceText}é€‰æ‹©ï¼‰â€¦`, "loading");

        try {
          const resp = await fetch(`${API_BASE}/generate_branch_episode`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              prompt,
              world_view,
              tone,
              choice,
              story_outline,
              choice_history: choiceHistory.slice(0, -1), // ä¸åŒ…æ‹¬å½“å‰é€‰æ‹©
              branch_depth: branchDepth,
            }),
          });

          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`HTTP ${resp.status}: ${text}`);
          }

          const data = await resp.json();
          const newFrames = data.frames || [];
          const newChoices = data.choices || [];

          // ç»™æ–°è¿½åŠ çš„åˆ†é•œé‡æ–°ç¼–å·ï¼Œæ¥åœ¨åŸæœ‰æ ¼å­ä¹‹å
          const baseIndex = (currentEpisode.frames || []).length;
          newFrames.forEach((f, i) => {
            f.index = baseIndex + i + 1;
          });

          currentEpisode.frames = [...currentEpisode.frames, ...newFrames];
          
          // æ›´æ–°é€‰æ‹©ç‚¹ï¼šä½¿ç”¨AIç”Ÿæˆçš„æ–°é€‰æ‹©ç‚¹ï¼ˆå¦‚æœæœ‰ï¼‰
          if (branchDepth >= 3) {
            // ç¬¬ä¸‰æ¬¡é€‰æ‹©åï¼Œæ•…äº‹ç»“æŸï¼Œä¸å†æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®
            currentEpisode.choices = [];
            setStatus("æ•…äº‹ç»“å±€å·²ç”Ÿæˆï¼Œå¼€å§‹æ’­æ”¾å®Œæ•´ç»“å±€â€¦", "success");
          } else if (newChoices.length > 0) {
            // å‰ä¸¤æ¬¡é€‰æ‹©åï¼Œä½¿ç”¨AIç”Ÿæˆçš„æ–°é€‰æ‹©ç‚¹
            currentEpisode.choices = newChoices;
            setStatus("æ•…äº‹æ®µè½å·²ç”Ÿæˆï¼Œè¯·åšå‡ºä¸‹ä¸€ä¸ªé€‰æ‹©â€¦", "success");
          } else {
            // å¦‚æœæ²¡æœ‰ç”Ÿæˆæ–°é€‰æ‹©ç‚¹ï¼Œæ¸…é™¤é€‰æ‹©æŒ‰é’®
            currentEpisode.choices = [];
            setStatus("æ•…äº‹æ®µè½å·²ç”Ÿæˆï¼Œç»§ç»­æ’­æ”¾â€¦", "success");
          }
          
          renderEpisode(currentEpisode);
          
          // ä»æ–°ç”Ÿæˆçš„æ ¼å¼€å§‹è‡ªåŠ¨æ’­æ”¾
          const startIndex = baseIndex;
          setTimeout(() => {
            autoPlayAllFrames(startIndex);
          }, 500);
        } catch (err) {
          console.error(err);
          setStatus("åˆ†æ”¯ç»­å†™å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚", "error");
        }
      }
      
      // ç”Ÿæˆå¦ä¸€ä¸ªç»“å±€
      async function generateAlternativeEnding(targetOutcome) {
        if (!currentEpisode) {
          setStatus("è¯·å…ˆç”Ÿæˆä¸€ä¸ªæ•…äº‹ã€‚", "error");
          return;
        }
        
        const prompt = promptInput.value.trim();
        const world_view = worldSelect.value || null;
        const tone = toneSelect.value || null;
        
        setStatus(`æ­£åœ¨ç”Ÿæˆã€Œ${targetOutcome}ã€ç»“å±€â€¦`, "loading");
        
        try {
          const resp = await fetch(`${API_BASE}/generate_alternative_ending`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              prompt,
              world_view,
              tone,
              current_path: storyPath,
              target_outcome: targetOutcome,
            }),
          });
          
          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`HTTP ${resp.status}: ${text}`);
          }
          
          const data = await resp.json();
          if (data.error) {
            throw new Error(data.error);
          }
          
          const newFrames = data.frames || [];
          const endingType = data.ending_type || targetOutcome;
          
          // åˆ›å»ºä¸€ä¸ªæ–°çš„"ç»“å±€åˆ†æ”¯"å±•ç¤ºåŒºåŸŸ
          const baseIndex = (currentEpisode.frames || []).length;
          newFrames.forEach((f, i) => {
            f.index = baseIndex + i + 1;
          });
          
          // åœ¨ç°æœ‰æ•…äº‹åé¢è¿½åŠ æ–°ç»“å±€
          const alternativeEnding = {
            ending_type: endingType,
            frames: newFrames,
            target_outcome: targetOutcome
          };
          
          // æ˜¾ç¤ºæ–°ç»“å±€ï¼ˆå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œæˆ–è€…è¿½åŠ åˆ°ç°æœ‰æ•…äº‹ï¼‰
          // è¿™é‡Œæˆ‘ä»¬è¿½åŠ åˆ°ç°æœ‰æ•…äº‹ï¼Œä½†æ ‡è®°ä¸º"å¦ä¸€ä¸ªç»“å±€"
          currentEpisode.frames = [...currentEpisode.frames, ...newFrames];
          currentEpisode.choices = []; // æ¸…é™¤é€‰æ‹©æŒ‰é’®
          
          renderEpisode(currentEpisode);
          setStatus(`ã€Œ${endingType}ã€ç»“å±€å·²ç”Ÿæˆï¼Œå¼€å§‹æ’­æ”¾â€¦`, "success");
          
          // ä»æ–°ç»“å±€å¼€å§‹æ’­æ”¾
          setTimeout(() => {
            autoPlayAllFrames(baseIndex);
          }, 500);
          
        } catch (err) {
          console.error(err);
          setStatus(`ç”Ÿæˆå¦ä¸€ä¸ªç»“å±€å¤±è´¥: ${err.message}`, "error");
        }
      }
    </script>
  </body>
  </html>

